name: update-master-flow

on:
  push:
    tags:        
      - 'v*'

jobs:
  minor-tag:
    if: github.event.base_ref == 'refs/heads/test-new-action' || startsWith(github.event.base_ref,'refs/heads/release/') != false
    runs-on: ubuntu-latest
    steps:
    - name: Get the tag version
      id: get_version
      run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
    - name: Checkout Plugin
      uses: actions/checkout@v2
      with:
        path: main
    - name: Checkout Vault
      uses: actions/checkout@v2
      with:
        repository: sarahethompson/vault
        token: ${{ secrets.SARAH_ACTIONS_PAT }}
        path: vault
    - uses: Dovyski/payload-info-action@master
      with:
        dump: true
    - uses: ./main/.github/actions/update-vault
      id: update-vault
      env:
        GOPRIVATE: "github.com/hashicorp/*"
        GITHUB_TOKEN: ${{ secrets.SARAH_ACTIONS_PAT }}
        VERSION: ${{ steps.get_version.outputs.VERSION }}
        ACTOR: ${{ github.event.head_commit.author.username }}
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      with:
        branch: 'master'
        update-strategy: '@latest'
        working-directory: 'vault'
    - name: Slack failure
      uses: act10ns/slack@v1
      id: slack-failure
      if: failure()
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      with:
        status: ${{ job.status }}
